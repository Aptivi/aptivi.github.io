@page "/old-articles"

<PageTitle>Old Articles - Aptivi</PageTitle>

@using System.Threading;
@using System.Net;
@using System.Text;
@using aptivi.github.io.Data
@using System.IO
@using System.Text.Json
@inject NavigationManager NavManager

<Hero Title="Old Articles">
	Here lists all our old articles that have been archived and that we think that it's worth
	archiving.
</Hero>

<Features FeatureArray="@articleDescriptors" />

@code {
	private static OldArticle[] articles;
	private static List<FeatureDescriptor> articleDescriptorsList = [];
	private static FeatureDescriptor[] articleDescriptors = [];

	protected override async Task OnInitializedAsync()
	{
		if (articles is null)
		{
			Stream stream = typeof(OldArticle).Assembly.GetManifestResourceStream("aptivi.github.io.Resources.OldArticles.json");
			articles = (OldArticle[])await JsonSerializer.DeserializeAsync(stream, typeof(OldArticle[]));
			foreach (var article in articles)
			{
				var attachmentButtons = new List<(EventCallback, string)>();
				if (article.ArticleAttachments is not null)
				{
					foreach (var attachment in article.ArticleAttachments)
					{
						string fileName = attachment.Substring(attachment.LastIndexOf('/') + 1);
						var callback = EventCallback.Factory.Create(this, new Action(() => NavManager.NavigateTo(attachment)));
						attachmentButtons.Add((callback, fileName));
					}
				}
				var articleDescriptor = new FeatureDescriptor()
				{
					IconClass = "fa fa-newspaper",
					Title = article.ArticleDate,
					Buttons = [
						(EventCallback.Factory.Create(this, new Action(() => NavManager.NavigateTo(article.ArticleLink))), "Read"),
						.. attachmentButtons
					],
					Description = article.ArticleTitle
				};
				articleDescriptorsList.Add(articleDescriptor);
			}
			articleDescriptors = [.. articleDescriptorsList];
		}
	}
}
